#!/usr/bin/env bash

keymaps() {
	if ! type xmodmap &>/dev/null || ! type xcape &>/dev/null || ! type setxkbmap &>/dev/null; then
		echo "xmodmap, xcape, or setxkbmap not found, skipping"
		return 1
	fi
	if [[ -z $DISPLAY && -z $ALWAYS_SET_CAPS ]]; then
		return
	fi
	local is_caps_already_mapped_to_control=$(xmodmap -pke | rg --count-matches "keycode\s+66\s*=\s*Control_L")
	local is_caps_already_mapped_to_escape=$(ps aux | rg --count-matches "xcape")
	if [[ $is_caps_already_mapped_to_control -gt 0 &&
		$is_caps_already_mapped_to_escape -gt 1 && -z ${ALWAYS_SET_CAPS:-} ]]; then
		return
	fi
	echo "Caps is not mapped to Control_L, mapping it now"
	echo "caps is currently mapped to: $(xmodmap -pke | rg "keycode\s+66\s*= ")"
	xmodmap -e 'clear Lock' \
		-e 'keycode 0x42 = Control_L' \
		-e 'keycode 169 = Delete';

	setxkbmap -option ctrl:nocaps
	xcape -e 'Control_L=Escape'
}

if type notify-send &>/dev/null; then
	msg="$(keymaps 2>&1)"
	[[ -n $msg ]] && notify-send -a "mapCapslock" "$msg" || true
else
	(keymaps)
fi
